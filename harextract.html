<!DOCTYPE html>
<html lang="en" class="h-100">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml"
          href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48IS0tIFVwbG9hZGVkIHRvOiBTVkcgUmVwbywgd3d3LnN2Z3JlcG8uY29tLCBHZW5lcmF0b3I6IFNWRyBSZXBvIE1peGVyIFRvb2xzIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IlVwbG9hZGVkIHRvIHN2Z3JlcG8uY29tIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiANCgkgd2lkdGg9IjgwMHB4IiBoZWlnaHQ9IjgwMHB4IiB2aWV3Qm94PSIwIDAgMzIgMzIiIHhtbDpzcGFjZT0icHJlc2VydmUiPg0KPHN0eWxlIHR5cGU9InRleHQvY3NzIj4NCgkuc2hhcnBjb3JuZXJzX2VlbntmaWxsOiMxMTE5MTg7fQ0KCS5zdDB7ZmlsbDojMTExOTE4O30NCjwvc3R5bGU+DQo8cGF0aCBjbGFzcz0ic2hhcnBjb3JuZXJzX2VlbiIgZD0iTTI5LDIyYzAsMi0xLjU4Niw0LjQyNS00LjMwNSw0LjkwNWMtMi43MTksMC40NzktNS4yMzUtMC44OTUtNS42MTktMy4wNzENCgljLTAuMzg0LTIuMTc2LDEuNTEtNC4zMjgsNC4yMjktNC44MDdjMS4zNjQtMC4yNDEsMi42NzYtMC4wMTQsMy42OTUsMC41NDZWOC40NjVsLTE1LDMuNTc5YzAsMCwwLDEwLjk1NiwwLDEyLjk1Ng0KCXMtMS41ODYsNC40MjUtNC4zMDUsNC45MDVjLTIuNzE5LDAuNDc5LTUuMjM1LTAuODk1LTUuNjE5LTMuMDcxYy0wLjM4NC0yLjE3NiwxLjUxLTQuMzI4LDQuMjI5LTQuODA3DQoJQzcuNjcsMjEuNzg2LDguOTgyLDIyLjAxMiwxMCwyMi41NzJWNi40MjFMMjksMkMyOSwyLDI5LDIwLDI5LDIyeiIvPg0KPC9zdmc+" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.css" integrity="sha512-MKxcSu/LDtbIYHBNAWUQwfB3iVoG9xeMCm32QV5hZ/9lFaQZJVaXfz9aFa0IZExWzCpm7OWvp9zq9gVip/nLMg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Music Utility</title>
    <style>
        header {
            background: black;
            color: white;
            font-size: xxx-large;
        }
        .closed .ifopen { display: none; }
        .open .ifclosed { display: none; }
        .invisible { display: none; }

        .noUi-connect {
            background: #0f6efd; /* set the bar colour */
        }
        .noUi-tooltip {
            display: none; /* hide the tooltip (unless active, below) */
        }
        .noUi-active .noUi-tooltip {
            display: block; /* show the tooltip when active */
        }

        .accordion-item .accordion-button{
            background:#e7f1ff; /* fix the accordions which don't seem to have borders */
        }
    </style>
    <script>
        let loaded = {};
        function alertError (context, e) {
            //let details = JSON.stringify(e, Object.getOwnPropertyNames(e), 2);
            //alert(`Error ${context}: ${e}\n\nDetails:\n\n${details}`);
            // that's an ugly dialog just do this instead:
            let summary = `Error ${context}: ${e.message}`;
            console.log(`harextract: ${summary}`);
            console.log(e);
            alert(`${summary}\n\nSee console for details.`);
        }
        function uiSetDocState (isopen) {
            document.body.classList.remove(isopen ? 'closed' : 'open');
            document.body.classList.add(isopen ? 'open' : 'closed');
        }
        function uiSetZipState (isbusy) {
            document.body.classList.remove(isbusy ? 'zipidle' : 'zipbusy');
            document.body.classList.add(isbusy ? 'zipbusy' : 'zipidle');
        }
        function clearUI () {
            loaded = {};
            uiSetDocState(false);
            uiSetZipState(false);
            document.querySelectorAll(".clearme").forEach((el) => el.innerHTML = '');
            document.querySelectorAll(".clearme").forEach((el) => el.innerHTML = '');
        }
        function strCompare (a, b) {
            return a.toLocaleLowerCase().localeCompare(b.toLocaleLowerCase());
        }
        function loadFailed (e) {
            clearUI();
            alertError('loading file', e);
        }
        function openHAR (input) {
            clearUI();
            if (!input.files || !input.files.length) {
                alert('No file selected.');
            } else {
                loaded.filename = input.files[0].name;
                domSetText('harfilename', loaded.filename);
                let reader = new FileReader();
                reader.onload = (e) => loadHARText(e.target.result);
                reader.onerror = (e) => loadFailed(reader.error);
                reader.readAsText(input.files[0]);
            }
        }
        function loadHARText (text) {
            let filter_ext =  document.getElementById("filter_extension").value;
            try {
                loadHARJSON(JSON.parse(text),filter_ext);
            } catch (e) {
                loadFailed(e);
            }
        }
        function loadHARJSON (har,filter_ext) {

            // extract and parse interesting entries
            let harents = [];
            let commonpath = null;
            for ([id,ent] of har.log.entries.entries()) {
                let harent = { id: id };
                let fullpath = new URL(ent.request.url).pathname.split('/');
                harent.name = fullpath.pop();
                harent.ext = harent.name.split('.').pop();
                harent.type = ent.response.content.mimeType;
                harent.size = ent.response.content.size;
                harent.pathcomps = fullpath; // .path string will be set below
                if(filter_ext !== 'all' && (harent.ext !== filter_ext)) {
                    //omit this as it doesn't match the filter extension
                }else {

                    if (!ent.response.content.text)
                        harent.error = 'No content.';
                    else if (ent.response.content.encoding !== 'base64')
                        harent.error = "Can't decode.";
                    if (harent.error) {
                        console.log(`harextract: skipped ${harent.name} (${id}): ${harent.error}`);
                    } else {
                        commonpath = fullpath.slice(0, [...fullpath, null].findIndex((p, n) => p !== (commonpath || fullpath)[n])); // ;)
                        harents.push(harent); // note: we can now guarantee that if harents has items, commonpath is set.
                    }
                }
            }

            // set path strings for all files; for non-skipped files, also strip common path prefixes.
            harents.forEach(ent => ent.path = ent.pathcomps.slice(commonpath.length).join('/'));

            let entsort = function (a,b) {
                let p = strCompare(a.path, b.path);
                return (p != 0) ? p : strCompare(a.name, b.name);
            }

            harents.sort(entsort);

            loaded.data = har.log.entries;
            loaded.entries = harents;

            // ui stuff from here down

            let makecheckbox = function (ent){
                let excludes = ['noplay.mp3','startup0.mp3'],
                    excluded = false;
                excludes.forEach(excl => {
                    if (ent.name.toLowerCase() === excl) excluded = true;
                })

                let c = document.createElement('input');
                c.type = 'checkbox';
                c.checked = !excluded;
                return c;
            }
            let makenamelink = function (ent) {
                a = document.createElement("a");
                let enc = har.log.entries[ent.id].response.content.encoding;
                let data = har.log.entries[ent.id].response.content.text;
                a.href = `data:${ent.type};${enc},${data}`;
                a.target = '_blank';
                a.download = ent.name;
                a.innerText = ent.name;
                return a;
            }

            populateTable('entryinfo', harents, [
                { name:'Checked',  value:makecheckbox },
                { name:'ID',       value:(e)=>e.id    },
                { name:'Filename', value:makenamelink },
                { name:'Type',     value:(e)=>e.type  },
                { name:'Size',     value:(e)=>e.size  },
                { name:'Path',     value:(e)=>e.path  }
            ]);

            uiSetDocState(true);

        }

        function pause(msec) {
            return new Promise(
                (resolve, reject) => {
                    setTimeout(resolve, msec || 1000);
                }
            );
        }


        async function saveChecked(){
            let links = document.querySelectorAll("table a"),
                counter = 0;

            console.log(links);
            for(link = 0; link < links.length; link++){
                //if checked, click it
                console.log('checking link',link, links[link]);
                let checked = links[link].parentNode.parentNode.querySelector('input').checked;
                if(checked) {
                    counter++;
                    if(counter % 10 === 0){
                        //chrome won't download more than 10 at once without a pause
                        await pause(1000);
                        console.log('waiting....');
                    }
                    links[link].click();
                }
            }
            window.alert('Saved ' + counter + ' links.');
        }
        function populateTable (tableid, items, fields) {

            let ebody;
            {
                let etable = document.getElementById(tableid);
                etable.innerHTML = '';
                let header = etable.createTHead().insertRow();
                for (field of fields)
                    domAppendTH(header).innerText = field.name;
                ebody = etable.createTBody();
            }

            for (ent of items) {
                let erow = ebody.insertRow();
                for (field of fields) {
                    let value = field.value(ent);
                    if (value instanceof Node)
                        erow.insertCell().appendChild(value);
                    else
                        erow.insertCell().innerText = value;
                }
            }

        }



        // i'd really like this to stay self-contained and offline, so i'm rolling my own
        // dom utility functions instead of using e.g. jquery.
        function domSetText (id, text) {
            document.querySelector(`#${id}`).innerText = text;
        }
        function domAppendTH (header) {
            // todo: shouldn't there be table api for this? insertCell only adds td's.
            let th = document.createElement('th');
            return header.appendChild(th);
        }
    </script>
</head>
<body class="closed zipidle d-flex flex-column h-100">
<header class="p-3 mb-3">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
            Music Utility
        </div>
    </div>
</header>
<div class="container flex-shrink-0 mb-3">
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Home</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="extract-tab" data-bs-toggle="tab" data-bs-target="#extract" type="button" role="tab" aria-controls="extract" aria-selected="false">Extract</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="player-tab" data-bs-toggle="tab" data-bs-target="#player" type="button" role="tab" aria-controls="player" aria-selected="false">Player</button>
        </li>
    </ul>
    <!-- INSTRUCTIONS TAB ---------------------------------------->
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
            <div class="row my-3">
                <h3>Instructions</h3>
                <div class="accordion" id="accordionExample">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingZero">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseZero" aria-expanded="false"
                                    aria-controls="collapseZero">
                                What is this for?
                            </button>
                        </h2>
                        <div id="collapseZero" class="accordion-collapse collapse" aria-labelledby="headingZero"
                             data-bs-parent="#accordionExample">
                            <div class="accordion-body">
                                <strong>Purpose</strong>
                                This tool was written for Evie Allsopp, to help bring some of the functionality of
                                Cyberbass to a mobile device, as well as letting her manage offline practice files.
                            </div>
                        </div>
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                How do I get a HAR file?
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                            <div class="accordion-body">
                                <strong>Instructions for Use</strong>
                                <ul>
                                    <li>Load <a href="https://cyberbass.org/" target="_blank">cyberbass</a> in Chrome and turn on inspection</li>
                                    <li>Inspect the network traffic, filtering to 'media' items if preferred</li>
                                    <li>Play each part you want to extract</li>
                                    <li>When you're done, download the HAR file from the browser and open it here</li>
                                    <li>Optionally clear your network traffic to start again</li>
                                </ul>
                            </div>
                        </div>
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                How do I play back the files?
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
                            <div class="accordion-body">
                                <strong>Playback</strong>
                                <ul>
                                    <li>Load the 'Player' tab</li>
                                    <li>Select the music file from your drive</li>
                                    <li>Use the controls to set the speed and optional loop</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- EXTRACT TAB ------------------------------------------------->
        <div class="tab-pane fade" id="extract" role="tabpanel" aria-labelledby="extract-tab">
            <!--
                HARExtract 0.9.2
                Copyright (C) 2021-2022, Jason Cipriani <jason.cipriani.dev ~ gmail.com>
                HARExtract home page: https://www.github.com/JC3/harextract

                This program is free software: you can redistribute it and/or modify
                it under the terms of the GNU General Public License as published by
                the Free Software Foundation, either version 3 of the License, or
                (at your option) any later version.

                This program is distributed in the hope that it will be useful,
                but WITHOUT ANY WARRANTY; without even the implied warranty of
                MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                GNU General Public License for more details.

                You should have received a copy of the GNU General Public License
                along with this program.  If not, see <https://www.gnu.org/licenses/>.

                --------------------------------------------------------------------------

                HARExtract uses the library JSZip 3.7.1 released under the GPLv3 license.
                JSZip Copyright (C) 2009-2016 Stuart Knightley
                JSZip home page: https://stuk.github.io/jszip/
                JSZip license: https://github.com/Stuk/jszip/blob/v3.7.1/LICENSE.markdown
            -->

            <div class="section">
                <div class="my-3 row">
                    <label for="filter_extension" class="col-md-2 col-form-label">Filter files</label>
                    <div class="col-md-10">
                        <select id="filter_extension" class="form-select">
                            <option value="mp3" selected>MP3</option>
                            <option value="mid">Midi</option>
                            <option value="all">All files</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3 row">

                    <label for="filter_extension" class="col-md-2 col-form-label">File select</label>
                    <div class="col-md-10">
                        <input type="file" accept=".har,application/json" onclick="this.value=null" onchange="openHAR(this)" class="invisible" id="harfileinput">
                        <label class="ifzipidle" for="harfileinput"><button class="btn btn-primary" onclick="this.parentElement.click()">Choose a HAR File...</button></label>
                        <span class="clearme" id="harfilename"></span>
                    </div>
                </div>
            </div>
            <div class="section ifopen">
                <table class="entryinfo clearme table" id="entryinfo"></table>
                <button type="button" class="btn btn-primary" onclick="saveChecked()">Save Checked</button>
            </div>
            <div class="text-muted mt-3 small">
                Extraction forked from HARExtract Copyright &copy; 2021-2022, Jason Cipriani
                | <a href="https://www.github.com/JC3/harextract/blob/master/LICENSE">GPLv3</a>
                | <a href="https://www.github.com/JC3/harextract">GitHub</a>
            </div>
        </div>

        <!-- PLAYER TAB --------------------------------------------------------------->
        <div class="tab-pane fade" id="player" role="tabpanel" aria-labelledby="player-tab">
            <div class="my-3 row">
                <label for="musicFile" class="col-md-2 col-form-label">Load file</label>
                <div class="col-md-10">
                    <input type="file"
                           multiple
                           id="musicFile" accept="*" onchange="loadTracksAndPlay()">
                </div>
            </div>
            <div class="my-3 row">
                <label for="playspeed" class="col-md-2 col-form-label">Playback speed (<span id="speedindicator">1.0</span>)</label>
                <div class="col-md-10">
                    <input type="range" class="form-range" min="0.2" max="1.8" step="0.1" id="playspeed" onchange="setSpeed(this.value)">
                    <button type="button" class="btn btn-primary" onclick="incrementSpeed(-0.1,true)">Slower</button>
                    <button type="button" id="resetSpeedButton"
                            class="btn btn-primary"
                            onclick="setSpeed('1.0',true)">Reset Speed</button>
                    <button type="button" class="btn btn-primary" onclick="incrementSpeed(0.1,true)">Faster</button>
                </div>
            </div>

            <div class="my-3 row">
                <hr/>
                <span class="col-md-2 col-form-label">Play controls</span>
                <div class="col-md-10">
                    <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="- 10 secs"
                            class="btn btn-primary" onclick="seek(-10)"><i class="bi bi-rewind-fill"></i></button>
                    <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="- 5 secs"
                            class="btn btn-primary" onclick="seek(-5)"><i class="bi bi-rewind"></i></button>
                    <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Pause"
                            class="btn btn-primary" onclick="play(false)"><i class="bi bi-pause"></i></button>
                    <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Play"
                            class="btn btn-primary" onclick="play(true)"><i class="bi bi-play"></i></button>
                    <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="+ 5 secs"
                            class="btn btn-primary" onclick="seek(+5)"><i class="bi bi-fast-forward"></i></button>
                    <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="+ 10 secs"
                            class="btn btn-primary" onclick="seek(+10)"><i class="bi bi-fast-forward-fill"></i></button>

                </div>
            </div>
            <div id="trackSelectionRow" class="my-3 row invisible"><!-- only if multi tracks -->
                <hr/>
                <span class="col-md-2 col-form-label">Track controls</span>
                <div class="col-md-10">
                    <div class="input-group">
                        <select id="trackSelector" class="form-select"></select>
                        <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Previous Track"
                                class="btn btn-primary" onclick="playTrack(-1)"><i class="bi bi-skip-backward-fill"></i></button>
                        <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Next Track"
                                class="btn btn-primary" onclick="playTrack(1)"><i class="bi bi-skip-forward-fill"></i></button>
                    </div>
                </div>
            </div>

            <div class="my-3 row">
                <hr/>
                <span class="col-md-2 col-form-label">Loop <span id="loopduration"></span></span>
                <div class="col-md-10">
                    <button type="button" class="btn btn-primary" onclick="setInOut('in',true)"><span
                            class="music-icon">ùÑÜ
                    </span> IN <span id="A"></span></button>
                    <button type="button" class="btn btn-primary" onclick="setInOut('out',true)"><span
                            class="music-icon">ùÑá
                    </span> OUT <span id="B"></span></button>
                    <button type="button" id="releaseloop" class="btn btn-danger invisible" onclick="releaseLoop()">Release Loop</button>
                </div>
            </div>
            <div class="my-3 row">
                <div class="col-md-10 offset-md-2">
                    <div id="slider" class="invisible"></div>
                </div>
            </div>

            <div class="my-3 row">
                <audio id="musicPlayer" controls="" ontimeupdate="considerLoop()"></audio>
            </div>

            <script>
                function update_label(which){
                    switch(which){
                        case 'in':
                            document.getElementById("A").innerHTML = "(" + fancyTimeFormat(config.A) + ")";
                            break;
                        case 'out':
                            document.getElementById("B").innerHTML = "(" + fancyTimeFormat(config.B) + ")";
                            break;
                    }
                    //update the duration
                    document.getElementById("loopduration").innerHTML = "(" + fancyTimeFormat(
                        (config.B ? config.B : config.music_player.duration) - config.A,true) + ")";
                }

                function setInOut(which, update_slider){
                    switch(which){
                        case 'in':
                            config.A = config.music_player.currentTime;
                            if(!config.B){
                                config.B = config.music_player.duration;
                            }
                            break;
                        case 'out':
                            config.B = config.music_player.currentTime;
                            break;
                    }
                    update_label(which);
                    document.getElementById("releaseloop").classList.remove('invisible');
                    document.getElementById("loopduration").classList.remove('invisible');

                    if(update_slider){
                        document.getElementById("slider").classList.remove('invisible');
                        var max = config.music_player.duration,
                            slide_start = config.A,
                            slide_end = config.B;
                        createSlider(slide_start,slide_end,max);
                    }
                }
                function updateIn(new_value){
                    config.A = new_value;
                    update_label('in');

                    //if A is ahead of current position, cue to there
                    if(config.music_player.currentTime < config.A){
                        config.music_player.currentTime = config.A;
                    }
                }
                function updateOut(new_value){
                    config.B = new_value;
                    update_label('out');
                }

                function play(go){
                    if(go) {
                        config.music_player.play();
                    }else{
                        config.music_player.pause();
                    }
                }
                function releaseLoop(){
                    config.A = config.B = 0;
                    document.getElementById("A").innerHTML = '';
                    document.getElementById("B").innerHTML = '';
                    document.getElementById("releaseloop").classList.add('invisible');
                    document.getElementById("loopduration").classList.add('invisible');
                    document.getElementById("slider").classList.add('invisible');

                }
                function considerLoop(){
                    if (config.B){
                        if(config.music_player.currentTime > config.B){
                            config.music_player.currentTime = config.A;
                        }
                    }
                }

                function playTrack(index){
                    config.track_index+=index;
                    console.log("playing track", index);

                    var track = config.tracks[config.track_index];

                    config.music_player.src = URL.createObjectURL(track);
                    setSpeed('1.0',true);
                    releaseLoop();
                    document.getElementById("trackSelector").value = track.name;
                    config.music_player.play();
                }

                function loadTracksAndPlay() {
                    config.tracks = document.getElementById("musicFile").files;
                    config.track_index = 0;
                    config.track_limit = config.tracks.length;

                    var trackSelector = document.getElementById("trackSelector");

                    //empty track selection
                    while (trackSelector.options.length > 0) {
                        trackSelector.remove(0);
                    }

                    //add tracks to the selection
                    for(const track of config.tracks){
                        let opt = document.createElement("option");
                        opt.text = track.name;
                        trackSelector.append(opt);
                    };

                    //show track selection row if multiple
                    var trackSelectionRow = document.getElementById("trackSelec tionRow");
                    trackSelectionRow.classList.toggle("invisible",config.tracks.length > 2);


                    playTrack(0);
                }
                function seek(seconds){
                    var target_time = config.music_player.currentTime + seconds;

                    //check you're after the start of the loop if present
                    if(config.A && target_time < config.A){
                        target_time = config.A;
                    }
                    config.music_player.currentTime = target_time;
                }
                function setSpeed(speed, updateControl) {
                    var speedIndicator = document.getElementById("speedindicator");

                    speed = Math.round(speed * 10) / 10; //dodge javascript floating point errors.

                    resetSpeedButton.classList.toggle('btn-primary', speed === 1);
                    resetSpeedButton.classList.toggle('btn-danger',speed !== 1);

                    config.music_player.playbackRate = speed;
                    speedIndicator.innerHTML = speed;
                    if(updateControl){
                        var rangeCtl = document.getElementById("playspeed");
                        rangeCtl.value = speed;
                    }
                }
                function incrementSpeed(adjustment,updateControl){
                    var desiredSpeed = config.music_player.playbackRate + adjustment,
                        newSpeed =  desiredSpeed > 1.8 ? 1.8 : desiredSpeed < 0.2 ? 0.2 : desiredSpeed;
                        setSpeed(newSpeed,updateControl)
                }

                function createSlider(start,end,max){
                    if (typeof slider.noUiSlider !== "undefined") slider.noUiSlider.destroy();
                    noUiSlider.create(slider, {
                        start: [start, end],
                        connect: true,
                        range: {
                            'min': 0,
                            'max': max
                        },
                        tooltips: {
                            // tooltips are output only, so only a "to" is needed
                            to: function(numericValue) {
                                return fancyTimeFormat(numericValue);
                            }
                        }
                    });

                    slider.noUiSlider.on('set', function (values,handle){
                        console.log(values,handle);
                        if(handle === 0){
                            updateIn(values[0]);
                        }else{
                            updateOut(values[1]);
                        }
                    });
                }

                function fancyTimeFormat(duration, use_letters) {
                    // Hours, minutes and seconds
                    const hrs = ~~(duration / 3600);
                    const mins = ~~((duration % 3600) / 60);
                    const secs = ~~duration % 60;

                    // Output like "1:01" or "4:03:59" or "123:03:59"
                    let ret = "";

                    if (hrs > 0) {
                        ret += "" + hrs + (use_letters ? "h ": ":") + (mins < 10 ? "0" : "");
                    }

                    ret += "" + mins + (use_letters ? "m " : ":") + (secs < 10 ? "0" : "");
                    ret += "" + secs + (use_letters ? "s" : "");

                    return ret;
                }


                </script>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.min.js" integrity="sha512-g/feAizmeiVKSwvfW0Xk3ZHZqv5Zs8PEXEBKzL15pM0SevEvoX8eJ4yFWbqakvRj7vtw1Q97bLzEpG2IVWX0Mg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    var config;

    document.addEventListener("DOMContentLoaded", function() {

        //enable tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')),
            tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                    trigger : 'hover'
                });
        });


        //setup slider
        var slider = document.getElementById('slider');

        //setup config
        config = {
            A: 0,
            B,
            music_player: document.getElementById("musicPlayer"),
            track_index: 0,
            tracks: []
        }

        //set up auto play of next file if available
        config.music_player.addEventListener('ended', function(){
            if(config.B){
                //we are looping, let it handle it.
            }else {
                playTrack(+1);
            }
        }, false);
    });
</script>
</body>
</html>
